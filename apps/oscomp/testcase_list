# ============ init code for oscomp test ============
# setup the environment
/musl/busybox mkdir -p /bin
/musl/busybox cp /musl/busybox /bin/busybox
# TODO: link busybox to /bin
busybox cp /musl/busybox /bin/ls
busybox mkdir -p /lib
busybox mkdir -p /lib64
busybox cp /musl/lib/dlopen_dso.so /musl
busybox cp /glibc/lib/dlopen_dso.so /glibc
busybox cp -v /glibc/lib/ld-linux-* /lib/

# ============ test cases compiled with musl ============
# setup musl libraries
# TODO: use symlink instead of cp
busybox cp /musl/lib/libc.so /lib/ld-musl-riscv64.so.1
busybox cp /musl/lib/libc.so /lib/ld-musl-x86_64.so.1
busybox cp /musl/lib/libc.so /lib/ld-musl-loongarch64.so.1
busybox cp /musl/lib/libc.so /lib/ld-musl-aarch64.so.1
busybox cp -v /musl/lib/* /lib/
busybox cp -r /lib/. /lib64/
busybox ls -l /lib64/
# begin test
# busybox echo "#### OS COMP TEST GROUP START basic-musl ####"
# /musl/basic_testcode.sh
# busybox echo "#### OS COMP TEST GROUP END basic-musl ####"
# /musl/libctest_testcode.sh
# /musl/busybox_testcode.sh
# /musl/lua_testcode.sh

# ============ test cases compiled with glibc ============
# setup glibc libraries
busybox cp -v /glibc/lib/libc.so.6 /lib/
busybox cp -v /glibc/lib/libm.so.6 /lib/
busybox cp -r /lib/. /lib64/
busybox ls -l /lib64/

# cd /glibc && /glibc/runtest.exe -w entry-dynamic.exe tls_get_new_dtv
busybox rm -r /glibc/basic/test_mkdir
busybox rm -r /glibc/basic/test_chdir
busybox rm /glibc/basic/mnt/test_openat
busybox rm /glibc/basic/test_mmap.txt
busybox rm /glibc/basic/test_close.txt

# begin test
busybox echo "#### OS COMP TEST GROUP START basic-glibc ####"
/glibc/basic_testcode.sh
busybox echo "#### OS COMP TEST GROUP END basic-glibc ####"
/glibc/busybox_testcode.sh
/glibc/lua_testcode.sh
